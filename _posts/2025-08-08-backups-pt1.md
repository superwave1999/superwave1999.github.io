---
title: "ZFS + Restic Backup Strategy - Part 1"
date: 2025-08-08
tags:
  - ZFS
  - Restic
  - Backups
  - Linux
  - Disaster Recovery
categories: [documentation]
---

# Prologue

Finally after all of this setup is complete we need to make sure the data, OS and configs are safe. This is the second reason why I installed ZFS.

## ZFS Glaze Nº10000

- What if a data drive fails? ZFS RAIDZ-1 (eq. to RAID-5).
- What if multiple data drives or the controller fails? Restic + S3.
- What if I fuck up an OS upgrade? ZFS + zfsbootmenu rollback procedure.
- What if the entire OS drive fails... Well, I'd have to reinstall Ubuntu following my own guide, but then I'd restore from my S3 via Restic.

(Nothing is perfect in life. I may or may not improve the final pain point in the future. If I do, you'll see it posted here)

## Restic setup for my data

We've already covered up ZFS, but we haven't covered Restic.

Restic is an open source single-executable, backup tool that encrypts on the client-side, removing duplicate data and storing the backups on another local location, SFTP, S3 and S3-compatible services.

My backup location of choice is Backblaze, but teaching you about setting up your Backblaze account is out of the scope of this guide, just the setup.

### Install Restic official binary

In my case I installed restic from source, although packaged versions for your Linux distribution may be available. If copying below, make sure you've installed `bzip2` and `wget`.

```bash
wget -O restic.bz2 https://github.com/restic/restic/releases/download/v0.18.0/restic_0.18.0_linux_amd64.bz2
bunzip2 restic.bz2
chmod +x restic
mv restic /usr/local/bin/
```

Make sure it works.

```bash
restic version
```

### Configure Restic

Create a credentials file for your user, for example `.restic-conf` in your homedir. Fill in with your data.

```bash
export AWS_ACCESS_KEY_ID=XXXXXXXXXXXXXXX
export AWS_SECRET_ACCESS_KEY=XXXXXXXXXXXXXXX
export RESTIC_REPOSITORY="s3:s3.your-region-001.backblazeb2.com/my-backup-bucket"
export RESTIC_PASSWORD_FILE=/home/imanol/.restic-pass # For example
```

Add a file that will contain the repository password (`.restic-pass`) in your homedir. With the following command, we'll generate a random password.

```bash
openssl rand -base64 32 > /home/imanol/.restic-pass
chmod 600 /home/imanol/.restic-pass
```

Make sure these envars are loaded into your terminal automatically by adding this line to your `.bashrc` file (you will probably have to re-login):

```bash
source .restic-conf
```

Now that your backup bucket is configured for your user, restic will bse these vars for convenience.

Create your new Restic repository that will be stored God knows where. You shouldn't see any errors.

```bash
restic init
```

### First backup

Let's do a first manual back up your important data! We will name it `first-backup`. If your files are located at `/storage/files` and `/storage/containerdata` you can do the following:

```bash
restic backup --verbose --skip-if-unchanged --compression max --tag first-backup /storage/files /storage/containerdata
```

### Removing old backups

In the following command, I want to cleanup old backups:

- --keep-daily 7 → Keep 1 snapshot per day for the last 7 days.
- --keep-weekly 4 → Keep 1 snapshot per week for the last 4 weeks.
- --keep-monthly 12 → Keep 1 snapshot per month for the last 12 months.
- --keep-within 1y → Keep everything from the last year, even if it doesn’t fit the above patterns.

```bash
restic forget --prune --keep-daily 7 --keep-weekly 4 --keep-monthly 12 --keep-within 1y
```

## ZFS snapshot setup for OS upgrades

Given my first guide (the ZFS Ubuntu guide), taking a ZFS snapshot is as simple as this:

```bash
zfs snapshot "zroot/ROOT/ubuntu@my-first-backup"
zfs snapshot "zroot/home@my-first-backup"
```

But I want to make a few changes. Keep in mind that these are my ZFS datasets. You can check yours with `zfs list -o name,mountpoint,canmount,com.sun:auto-snapshot,mounted`.

```text
zroot/ROOT/ubuntu on / type zfs (rw,relatime,xattr,posixacl,casesensitive)
zroot/home on /home type zfs (rw,relatime,xattr,posixacl,casesensitive)
datapool on /storage type zfs (rw,noatime,xattr,noacl,casesensitive)
```

### The ✨changes✨

I want my scripts, docker data and files backed up via Restic, and OS data to be backed up via ZFS snapshots with no overlap betweem both. Sysadmins will cringe that I'm not following the 3-2-1 rule, but I'll take my chances.

ZFS snapshots are hierarchical. So sub-datasets are included by default in backups of parent datasets.

First, let's get my data drive snapshots out of the way. These shouldn't be included with root datasets, since this is a completely separate dataset, but we can add the exclusion tag:

```bash
zfs set com.sun:auto-snapshot=false datapool
```

### Moving a directory into its own dataset post-install

In my case, I also have non-OS data stored in a directory called `/storage-core` on the system SSD. This is backed up by Restic, so I'd like to grant it its' own dataset, since this directory has a different purpose (and to exclude or use a different snapshot schema).

This is quite complex, so make sure that nobody is using this directory, all non-essential programs and services (docker) are stopped.

#### Back up the target directory

```bash
sudo mv /storage-core /storage-core.backup
sudo mkdir /storage-core
```

#### Create your new dataset

```bash
sudo zfs create zroot/storage-core
```

#### Assign tags and mount points to the dataset

```bash
sudo zfs set com.sun:auto-snapshot=false zroot/storage-core
sudo zfs set mountpoint=/storage-core zroot/storage-core
```

#### Checking mount status and copying data back

```bash
zfs list -o name,mountpoint,canmount,com.sun:auto-snapshot,mounted

sudo rsync -aAXv /storage-core.backup/ /storage-core/
```

#### Reboot, manual checks

Finally reboot your machine. Make sure that all files copied back are present, and everything is working.

When 100% sure, remove the temporary directory. I'm not responsible for any data loss.

```bash
sudo rm -rf /storage-core.backup
```

# Epilogue

Now you know how to create remote backups, ZFS snapshots, and prune excess data. Nonetheless, your knowledge this can be expanded with the following resources:

- Sanoid - I considered this a bit overkill for my use at least at the time of writing.
- My own scripts - With one command we check mounts, and perform all backup tasks at-will.
- Restic documentation

The next steps: simulating disaster scenarios and restoring data and OS snapshots from zfsbootmenu.
